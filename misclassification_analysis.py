"""
èª¤åˆ†é¡åˆ†æã¨æ”¹å–„ç­–ææ¡ˆã‚·ã‚¹ãƒ†ãƒ 
è„‚æ¼æ€§è§’åŒ–ç—‡ï¼ˆSKï¼‰ã®èª¤åˆ†é¡ã‚±ãƒ¼ã‚¹åˆ†æ
"""

import torch
import torch.nn as nn
import torchvision.transforms as transforms
from torchvision.models import efficientnet_v2_s
from PIL import Image
import numpy as np
import matplotlib.pyplot as plt
import os
import json

# ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
device = torch.device('mps' if torch.backends.mps.is_available() else 'cuda' if torch.cuda.is_available() else 'cpu')

class DiseaseClassificationModel(nn.Module):
    def __init__(self, num_classes=2, dropout_rate=0.3):
        super().__init__()
        self.backbone = efficientnet_v2_s(weights='IMAGENET1K_V1')
        num_features = self.backbone.classifier[1].in_features
        
        self.backbone.classifier = nn.Sequential(
            nn.Dropout(dropout_rate),
            nn.Linear(num_features, 512),
            nn.ReLU(),
            nn.Dropout(dropout_rate),
            nn.Linear(512, 256),
            nn.ReLU(),
            nn.Dropout(dropout_rate),
            nn.Linear(256, num_classes)
        )
    
    def forward(self, x):
        return self.backbone(x)

def analyze_sk_performance():
    """SKï¼ˆè„‚æ¼æ€§è§’åŒ–ç—‡ï¼‰ã®æ€§èƒ½åˆ†æ"""
    print("ğŸ“Š è„‚æ¼æ€§è§’åŒ–ç—‡ï¼ˆSKï¼‰æ€§èƒ½åˆ†æ")
    print("=" * 60)
    
    # æ—¢å­˜ã®è©•ä¾¡çµæœã‚’èª­ã¿è¾¼ã¿
    results_path = '/Users/iinuma/Desktop/ãƒ€ãƒ¼ãƒ¢/disease_classification_results.json'
    if os.path.exists(results_path):
        with open(results_path, 'r', encoding='utf-8') as f:
            results = json.load(f)
        
        sk_results = results['diseases'].get('SK', {})
        print(f"âœ… SKæ€§èƒ½ï¼ˆè¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼‰:")
        print(f"   æ­£è§£ç‡: {sk_results.get('correct', 0)}/{sk_results.get('total', 0)} ({sk_results.get('accuracy', 0):.1%})")
        print(f"   ç¢ºä¿¡åº¦: {sk_results.get('confidence', 0):.1%}")
        
        overall = results['overall']
        print(f"\\nğŸ“ˆ å…¨ä½“æ€§èƒ½:")
        print(f"   ç‰¹ç•°åº¦: {overall.get('specificity', 0):.1%}")
        print(f"   æ„Ÿåº¦: {overall.get('sensitivity', 0):.1%}")
    
def identify_improvement_strategies():
    """æ”¹å–„æˆ¦ç•¥ã®ç‰¹å®š"""
    print("\\nğŸ¯ èª¤åˆ†é¡æ”¹å–„æˆ¦ç•¥")
    print("=" * 60)
    
    strategies = {
        "1. ãƒ‡ãƒ¼ã‚¿å“è³ªæ”¹å–„": {
            "description": "ã‚ˆã‚Šå¤šæ§˜ã§é«˜å“è³ªãªSKãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ",
            "å…·ä½“ç­–": [
                "æ§˜ã€…ãªéƒ¨ä½ã®SKç”»åƒã‚’è¿½åŠ åé›†",
                "ç•°ãªã‚‹ç…§æ˜æ¡ä»¶ã§ã®æ’®å½±ç”»åƒ",
                "å¤šæ§˜ãªæ‚£è€…å¹´é½¢ãƒ»è‚Œè‰²ã§ã®ç—‡ä¾‹",
                "å¢ƒç•ŒãŒæ˜ç¢ºãªSKç—‡ä¾‹ã®è¿½åŠ ",
                "çš®è†šé¡ç”»åƒã®å“è³ªå‘ä¸Š"
            ],
            "åŠ¹æœ": "ãƒ‡ãƒ¼ã‚¿ã®ä»£è¡¨æ€§å‘ä¸Šã«ã‚ˆã‚Šæ±åŒ–æ€§èƒ½å‘ä¸Š"
        },
        
        "2. ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µæˆ¦ç•¥": {
            "description": "SKç‰¹æœ‰ã®ç‰¹å¾´ã‚’ä¿æŒã—ãŸæ‹¡å¼µæ‰‹æ³•",
            "å…·ä½“ç­–": [
                "SKç‰¹æœ‰ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä¿æŒã™ã‚‹æ‹¡å¼µ",
                "è‰²èª¿å¤‰æ›ã®ç¯„å›²èª¿æ•´",
                "ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿æ‰‹æ³•ã®æ”¹å–„",
                "ãƒã‚¤ã‚ºé™¤å»å‰å‡¦ç†ã®è¿½åŠ ",
                "å¤šæ®µéšãƒ‡ãƒ¼ã‚¿æ‹¡å¼µ"
            ],
            "åŠ¹æœ": "SKã®ç‰¹å¾´çš„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å­¦ç¿’å¼·åŒ–"
        },
        
        "3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„": {
            "description": "SKè­˜åˆ¥ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«æ§‹é€ ",
            "å…·ä½“ç­–": [
                "æ³¨æ„æ©Ÿæ§‹ï¼ˆAttentionï¼‰ã®å°å…¥",
                "ãƒãƒ«ãƒã‚¹ã‚±ãƒ¼ãƒ«ç‰¹å¾´æŠ½å‡º",
                "SKã®ç‰¹å¾´çš„ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºå±¤",
                "ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å­¦ç¿’ã®å°å…¥",
                "Vision Transformerã®æ¤œè¨"
            ],
            "åŠ¹æœ": "ç´°ã‹ãªç‰¹å¾´ã®è­˜åˆ¥èƒ½åŠ›å‘ä¸Š"
        },
        
        "4. æå¤±é–¢æ•°æœ€é©åŒ–": {
            "description": "SKèª¤åˆ†é¡ã‚’é‡ç‚¹çš„ã«æ”¹å–„ã™ã‚‹æå¤±é–¢æ•°",
            "å…·ä½“ç­–": [
                "Focal Lossã®å°å…¥",
                "ã‚¯ãƒ©ã‚¹é‡ã¿å‹•çš„èª¿æ•´",
                "é›£ä¾‹ãƒã‚¤ãƒ‹ãƒ³ã‚°",
                "SKç‰¹åŒ–å‹æå¤±é–¢æ•°",
                "ä¸å‡è¡¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œæå¤±"
            ],
            "åŠ¹æœ": "å›°é›£ç—‡ä¾‹ã§ã®åˆ¤å®šç²¾åº¦å‘ä¸Š"
        },
        
        "5. ç‰¹å¾´å·¥å­¦å¼·åŒ–": {
            "description": "SKç‰¹æœ‰ã®è¦–è¦šçš„ç‰¹å¾´ã®æ˜ç¤ºçš„å­¦ç¿’",
            "å…·ä½“ç­–": [
                "è‰²ç´ æ²ˆç€ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ",
                "è¡¨é¢ãƒ†ã‚¯ã‚¹ãƒãƒ£ç‰¹å¾´æŠ½å‡º",
                "å¢ƒç•Œç·šæ˜ç­æ€§è©•ä¾¡",
                "æ¯›åš¢é–‹å£éƒ¨ã®æ¤œå‡º",
                "å¤šé‡è§£åƒåº¦ç‰¹å¾´èåˆ"
            ],
            "åŠ¹æœ": "SKã®è¨ºæ–­æŒ‡æ¨™ã«åŸºã¥ãåˆ¤å®š"
        },
        
        "6. å¾Œå‡¦ç†ãƒ»æ¤œè¨¼å±¤": {
            "description": "åˆ¤å®šçµæœã®ä¿¡é ¼æ€§å‘ä¸Š",
            "å…·ä½“ç­–": [
                "ä¸ç¢ºå®Ÿæ€§æ¨å®šã®å°å…¥",
                "è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«",
                "æ®µéšçš„åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ",
                "ä¿¡é ¼åº¦é–¾å€¤ã®å‹•çš„èª¿æ•´",
                "å°‚é–€åŒ»ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ©ã‚°"
            ],
            "åŠ¹æœ": "èª¤åˆ¤å®šãƒªã‚¹ã‚¯ã®æœ€å°åŒ–"
        }
    }
    
    for key, strategy in strategies.items():
        print(f"\\n{key}: {strategy['description']}")
        print(f"   åŠ¹æœ: {strategy['åŠ¹æœ']}")
        print("   å…·ä½“çš„æ–½ç­–:")
        for action in strategy['å…·ä½“ç­–']:
            print(f"     â€¢ {action}")
    
def analyze_current_limitations():
    """ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã®é™ç•Œåˆ†æ"""
    print("\\nâš ï¸ ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ é™ç•Œåˆ†æ")
    print("=" * 60)
    
    limitations = {
        "ãƒ‡ãƒ¼ã‚¿é–¢é€£": [
            "SKç—‡ä¾‹æ•°ã®ç›¸å¯¾çš„ä¸è¶³ï¼ˆ111æš vs æ‚ªæ€§521æšï¼‰",
            "SKå†…ã§ã®å¤šæ§˜æ€§ä¸è¶³",
            "å¢ƒç•Œç—‡ä¾‹ã®ä¸è¶³",
            "ç”»åƒå“è³ªã®ã°ã‚‰ã¤ã"
        ],
        
        "ãƒ¢ãƒ‡ãƒ«é–¢é€£": [
            "æ‚ªæ€§ãƒ‡ãƒ¼ã‚¿ã«åã£ãŸå­¦ç¿’",
            "SKã®ç‰¹å¾´çš„ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’ä¸è¶³",
            "éä¿¡å•é¡Œï¼ˆ99.8%ç¢ºä¿¡åº¦ï¼‰",
            "ä¸ç¢ºå®Ÿæ€§æ¨å®šã®æ¬ å¦‚"
        ],
        
        "è©•ä¾¡é–¢é€£": [
            "å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã§ã®æ¤œè¨¼ä¸è¶³",
            "è‡¨åºŠå°‚é–€åŒ»ã¨ã®æ¯”è¼ƒä¸è¶³",
            "ã‚¨ãƒ©ãƒ¼ç—‡ä¾‹ã®è©³ç´°åˆ†æä¸è¶³",
            "ãƒªã‚¢ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰æ€§èƒ½è©•ä¾¡ä¸è¶³"
        ]
    }
    
    for category, issues in limitations.items():
        print(f"\\n{category}:")
        for issue in issues:
            print(f"   â€¢ {issue}")

def propose_immediate_solutions():
    """å³åº§ã«å®Ÿè£…å¯èƒ½ãªè§£æ±ºç­–"""
    print("\\nğŸš€ å³åº§ã«å®Ÿè£…å¯èƒ½ãªæ”¹å–„ç­–")
    print("=" * 60)
    
    immediate_solutions = {
        "1. ä¸ç¢ºå®Ÿæ€§æ¨å®šã®è¿½åŠ ": {
            "å®Ÿè£…": "ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«",
            "åŠ¹æœ": "äºˆæ¸¬ã®ä¿¡é ¼æ€§è©•ä¾¡",
            "å·¥æ•°": "1-2æ—¥"
        },
        
        "2. é–¾å€¤èª¿æ•´": {
            "å®Ÿè£…": "SKã«å¯¾ã™ã‚‹åˆ¤å®šé–¾å€¤ã®æœ€é©åŒ–",
            "åŠ¹æœ": "å½é™½æ€§ç‡ã®å‰Šæ¸›",
            "å·¥æ•°": "åŠæ—¥"
        },
        
        "3. æ®µéšçš„åˆ¤å®š": {
            "å®Ÿè£…": "ç¢ºä¿¡åº¦ã«åŸºã¥ãæ®µéšçš„è¨ºæ–­",
            "åŠ¹æœ": "ãƒªã‚¹ã‚¯éšå±¤åŒ–",
            "å·¥æ•°": "1æ—¥"
        },
        
        "4. SKãƒ‡ãƒ¼ã‚¿æ‹¡å¼µ": {
            "å®Ÿè£…": "æ—¢å­˜SKç”»åƒã®é«˜åº¦ãªæ‹¡å¼µ",
            "åŠ¹æœ": "å­¦ç¿’ãƒ‡ãƒ¼ã‚¿å¢—åŠ ",
            "å·¥æ•°": "1æ—¥"
        },
        
        "5. ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å­¦ç¿’": {
            "å®Ÿè£…": "è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®çµ„ã¿åˆã‚ã›",
            "åŠ¹æœ": "åˆ¤å®šå®‰å®šæ€§å‘ä¸Š",
            "å·¥æ•°": "2-3æ—¥"
        }
    }
    
    for solution, details in immediate_solutions.items():
        print(f"\\n{solution}:")
        print(f"   å®Ÿè£…æ–¹æ³•: {details['å®Ÿè£…']}")
        print(f"   æœŸå¾…åŠ¹æœ: {details['åŠ¹æœ']}")
        print(f"   å¿…è¦å·¥æ•°: {details['å·¥æ•°']}")

def clinical_validation_recommendations():
    """è‡¨åºŠæ¤œè¨¼ã®æ¨å¥¨äº‹é …"""
    print("\\nğŸ¥ è‡¨åºŠæ¤œè¨¼ã®æ¨å¥¨äº‹é …")
    print("=" * 60)
    
    recommendations = [
        "å°‚é–€çš®è†šç§‘åŒ»ã«ã‚ˆã‚‹è¨ºæ–­çµæœã®æ¤œè¨¼",
        "å¤šæ–½è¨­ã§ã®æ€§èƒ½è©•ä¾¡",
        "ãƒªã‚¢ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã§ã®æ¤œè¨¼",
        "æ‚£è€…å¤šæ§˜æ€§ã‚’è€ƒæ…®ã—ãŸè©•ä¾¡",
        "è¨ºæ–­ãƒ—ãƒ­ã‚»ã‚¹ã®é€æ˜æ€§å‘ä¸Š",
        "ç¶™ç¶šçš„å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰",
        "åŒ»å¸«-AIå”èª¿è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™º"
    ]
    
    for i, rec in enumerate(recommendations, 1):
        print(f"{i}. {rec}")

def main():
    """ãƒ¡ã‚¤ãƒ³åˆ†æå®Ÿè¡Œ"""
    print("ğŸ”¬ è„‚æ¼æ€§è§’åŒ–ç—‡ï¼ˆSKï¼‰èª¤åˆ†é¡æ”¹å–„åˆ†æ")
    print("   è‰¯æ€§SK â†’ æ‚ªæ€§èª¤åˆ¤å®šã‚±ãƒ¼ã‚¹ã®å¯¾ç­–")
    print("=" * 80)
    
    print("\\nğŸ“‹ ç¾åœ¨ã®å•é¡Œ:")
    print("â€¢ images.jpegï¼ˆè„‚æ¼æ€§è§’åŒ–ç—‡ï¼‰ã‚’99.8%ç¢ºä¿¡åº¦ã§æ‚ªæ€§ã¨èª¤åˆ¤å®š")
    print("â€¢ SKã®ä¸€éƒ¨ç—‡ä¾‹ã§å½é™½æ€§ï¼ˆè‰¯æ€§â†’æ‚ªæ€§èª¤åˆ¤å®šï¼‰ãŒç™ºç”Ÿ")
    
    # åˆ†æå®Ÿè¡Œ
    analyze_sk_performance()
    identify_improvement_strategies()
    analyze_current_limitations()
    propose_immediate_solutions()
    clinical_validation_recommendations()
    
    print("\\n" + "=" * 80)
    print("ğŸ“ æ”¹å–„å„ªå…ˆé †ä½")
    print("=" * 80)
    print("1. ğŸ”´ æœ€å„ªå…ˆ: ä¸ç¢ºå®Ÿæ€§æ¨å®šã®å°å…¥")
    print("2. ğŸŸ¡ é‡è¦: SKãƒ‡ãƒ¼ã‚¿ã®æ‹¡å……")
    print("3. ğŸŸ¡ é‡è¦: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«å­¦ç¿’ã®å®Ÿè£…")
    print("4. ğŸŸ¢ ä¸­æœŸ: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„")
    print("5. ğŸŸ¢ é•·æœŸ: è‡¨åºŠæ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰")
    
    print("\\nğŸ’¡ æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("1. ä¸ç¢ºå®Ÿæ€§æ¨å®šæ©Ÿèƒ½ã®å®Ÿè£…")
    print("2. SKç—‡ä¾‹ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ åé›†")
    print("3. è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ã®æ§‹ç¯‰")
    print("4. è‡¨åºŠå°‚é–€åŒ»ã¨ã®æ€§èƒ½æ¯”è¼ƒ")

if __name__ == "__main__":
    main()